name: Ping Pinecone Index

on:
  schedule:
    # Ch·∫°y m·ªói ng√†y l√∫c 20:00 UTC
    - cron: "0 20 * * *"
  workflow_dispatch: # Cho ph√©p ch·∫°y th·ªß c√¥ng n·∫øu mu·ªën

jobs:
  ping:
    runs-on: ubuntu-latest

    steps:
      - name: Ping Pinecone Endpoint
        env:
          ENDPOINT_URL: https://ainote.lionguyen.com/api/pinecone-ping
        run: |
          echo "üîî Pinging Pinecone index at: $ENDPOINT_URL"

          MAX_RETRIES=3
          RETRY_DELAY=10

          for i in $(seq 1 $MAX_RETRIES); do
            STATUS=$(curl -s -o /tmp/ping_output.txt -w "%{http_code}" "$ENDPOINT_URL")

            if [ "$STATUS" -eq 200 ]; then
              echo "‚úÖ Ping succeeded (HTTP 200)"
              cat /tmp/ping_output.txt
              exit 0
            else
              echo "‚ö†Ô∏è Attempt $i failed (status: $STATUS)"
              if [ "$i" -lt "$MAX_RETRIES" ]; then
                echo "‚è≥ Retrying in $RETRY_DELAY seconds..."
                sleep $RETRY_DELAY
              fi
            fi
          done

          echo "‚ùå All ping attempts failed."
          cat /tmp/ping_output.txt
          exit 1
